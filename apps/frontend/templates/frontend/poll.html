{% extends 'base.html' %}

{% block content %}

<script>
    var currentQuestion = null;
    var SelectedAnswers = [{{selected_answers}}];

    var loc = window.location;
    var wsStart = 'ws://';
    if (loc.protocol == 'https:') {
        wsStart = 'wss://'
    }

    // see https://channels.readthedocs.io/en/stable/tutorial/part_2.html
    const chatSocket = new WebSocket(
        wsStart + window.location.host + '/ws/poll/{{poll.id}}/'
    );

    function update_results(answers) {
        let resultsDiv = document.getElementById('results');
        let newContent = '';
        let totalvotes = 0;
        newContent += '<ul>';
        labels = [];
        values = [];
        answers.forEach(function(answer){
            newContent +=
                '<li>' + answer.votes + ' ' + answer.answer + '</li>';
            labels.push(answer.answer);
            values.push(answer.votes);
            totalvotes += answer.votes;
            });

        newContent += '</ul>';

        resultsDiv.innerHTML = "Total Votes: " + totalvotes + '<br/><br/>' + newContent;

        var type = 'bar';
        // var type = 'pie';
        var data = null;
        if (type == 'bar') {
            // see https://plotly.com/javascript/bar-charts/#basic-bar-chart
            data = [{x: labels, y: values, type: 'bar'}];
        } else if (type == 'pie') {
            // see https://plotly.com/javascript/pie-charts/
            data = [{values: values, labels: labels, type: 'pie'}];
        }
        var layout = {
            height: 400,
            width: 500
          };
        Plotly.newPlot('chart', data); // , layout);
    }

    var httpRequest;
    function update_selected_answers_show() {

        SelectedAnswers = [];

        if (httpRequest.readyState === XMLHttpRequest.DONE) {
            SelectedAnswers = JSON.parse(httpRequest.responseText);
            SelectedAnswers = SelectedAnswers.selected_answers;

            // TODO update class selected in answers
            answerButtons = document.querySelectorAll('.answer');
            answerButtons.forEach(function(btn) {
                const answer_id = parseInt(btn.getAttribute("answer_id"));
                if (SelectedAnswers.includes(answer_id)) {
                    // mark as selected
                    btn.className += " selected";
                } else {
                    // mark as not selected
                    btn.className = btn.className.replaceAll("selected", "");
                }

            });
        }
    }

    function update_selected_answers() {
        var loc = window.location;

        httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = update_selected_answers_show;
        httpRequest.open('GET', window.location.protocol + '//' + window.location.host + '/selected_answers/{{poll.id}}');
        httpRequest.send();
    }

    function update_question(data) {
        let question = document.getElementById('question');
        let newContent = data.question;
        newContent += '<ul>';

        data.answers.forEach(function(answer){
            newContent +=
                '<li><button type="submit" class="answer" msg="' + answer.answer + '" answer_id="' + answer['id'] + '">' + answer.answer + '</button></li>';
          });

        newContent += '</ul>';
        question.innerHTML = newContent;
        update_selected_answers();

        answerButtons = document.querySelectorAll('.answer');
        answerButtons.forEach(function(btn) {
            btn.onclick = function(e) {
                const message = e.srcElement.getAttribute("msg");
                const answer_id = parseInt(e.srcElement.getAttribute("answer_id"));
                chatSocket.send(JSON.stringify({
                    'type': 'answer',
                    'answer_id': answer_id,
                    'message': message
                }));

                // immediate feedback, might be wrong, if only one answer can be selected
                if (SelectedAnswers.includes(answer_id)) {
                    // remove the answer
                    index = SelectedAnswers.indexOf(answer_id);
                    SelectedAnswers.splice(index, 1);
                    e.srcElement.className = e.srcElement.className.replaceAll("selected", "");
                } else {
                    // add the answer
                    SelectedAnswers.push(answer_id);
                    e.srcElement.className += " selected";
                }
                // wait half a second, then update the button selections, this is for single answer questions.
                setTimeout(update_selected_answers, 500);
            }
        });

        // clear the results
        let resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        let chartDiv = document.getElementById('chart');
        chartDiv.innerHTML = '';
    }

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
console.log(data);
        if (data.type == 'update_results') {
            update_results(data.answers);
        }
        else if (data.type === 'new_question') {
            currentQuestion = data.question;
            update_question(data);
        }
        // do not overwrite current question by refresh
        else if (data.type === 'refresh_question') {
            if (currentQuestion !== data.question) {
                currentQuestion = data.question;
                update_question(data);
            }
        }
    };

    function init() {
        // request the question and options
        chatSocket.send(JSON.stringify({
            'type': 'init',
            'message': 'init'
        }));
    }
    setTimeout(init, 500);

    chatSocket.onclose = function(e) {
        console.error('Socket closed unexpectedly');
        alert('connection lost, please refresh the browser')
    };
</script>

<div class="container">
    <h3>Answer Poll {{poll.name}}</h3>

    <div id="question"></div>

    <div id="chart"></div>
    <div id="results"></div>
</div>

{% endblock %}
