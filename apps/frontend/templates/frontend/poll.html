{% extends 'base.html' %}

{% block content %}

<script>
    currentQuestion = null;

    // see https://channels.readthedocs.io/en/stable/tutorial/part_2.html
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/poll/{{poll.id}}/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
console.log(data);
        if (data.type !== 'new_question' && data.type !== 'refresh_question') {
            return;
        }
        // do not overwrite current question by refresh
        if (currentQuestion === data.question && data.type === 'refresh_question') {
            return;
        }
        currentQuestion = data.question;
console.log('new question: ' + data.question);
        let question = document.getElementById('question');
        let newContent= data.question;
        newContent += '<ul>';

        data.answers.forEach(function(answer){
            newContent +=
                '<li><button type="submit" class="answer" msg="' + answer + '">' + answer + '</button></li>';
          });

          newContent += '</ul>';
        question.innerHTML = newContent;

        answerButtons = document.querySelectorAll('.answer');
        answerButtons.forEach(function(btn) {
            btn.onclick = function(e) {
                const message = e.srcElement.getAttribute("msg");
                chatSocket.send(JSON.stringify({
                    'type': 'answer',
                    'message': message
                }));
            }
        });
    };

    function init() {
        // request the question and options
        chatSocket.send(JSON.stringify({
            'type': 'init',
            'message': 'init'
        }));
    }
    setTimeout(init, 500);

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>

<div class="container">
    <h3>Answer Poll {{poll.name}}</h3>

    <div id="question"></div>
</div>

{% endblock %}
